@page "/"
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>MonaPilot - Dashboard</PageTitle>

<div class="dashboard">
    <div class="header">
        <h1>?? MonaPilot Dashboard</h1>
        <button @onclick="Logout" class="btn-logout">Logout</button>
    </div>

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="stats">
            <div class="stat-card">
                <h3>?? Total Requests</h3>
                <p class="number">@totalRequests</p>
            </div>
            <div class="stat-card">
                <h3>? Completed</h3>
                <p class="number">@completedRequests</p>
            </div>
            <div class="stat-card">
                <h3>?? Total Spent</h3>
                <p class="number">?@totalSpent</p>
            </div>
        </div>

        <div class="section">
            <h2>New Request</h2>
            <div class="form">
                <input type="text" @bind="newRequest.PersonName" placeholder="Name" />
                <input type="number" @bind="newRequest.Budget" placeholder="Budget" />
                <select @bind="newRequest.ProductType">
                    <option>Electronics</option>
                    <option>Furniture</option>
                    <option>Books</option>
                </select>
                <button @onclick="CreateRequest" class="btn-primary">Submit</button>
            </div>
        </div>

        <div class="section">
            <h2>Recent Activity</h2>
            @if (logs.Count > 0)
            {
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in logs.Take(10))
                        {
                            <tr>
                                <td>@log.PersonName</td>
                                <td>@log.ProductName</td>
                                <td>?@log.ProductPrice</td>
                                <td><span class="badge @log.Status.ToLower()">@log.Status</span></td>
                                <td>@log.CreatedAt.ToString("MM/dd HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No activity yet</p>
            }
        </div>
    }
</div>

@code {
    private bool isLoading = true;
    private int totalRequests = 0;
    private int completedRequests = 0;
    private decimal totalSpent = 0;
    private List<ActivityLog> logs = new();
    
    private CreateRequestDto newRequest = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;
            var response = await Http.GetAsync("api/productrequest/logs/all");
            
            if (response.IsSuccessStatusCode)
            {
                logs = await response.Content.ReadAsAsync<List<ActivityLog>>();
                totalRequests = logs.Count;
                completedRequests = logs.Count(l => l.Status == "Success");
                totalSpent = logs.Sum(l => l.ProductPrice);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CreateRequest()
    {
        try
        {
            var response = await Http.PostAsJsonAsync("api/productrequest/request", newRequest);
            if (response.IsSuccessStatusCode)
            {
                newRequest = new();
                await LoadData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void Logout()
    {
        // Clear token
        sessionStorage.RemoveItem("authToken");
        Nav.NavigateTo("/login");
    }

    public class ActivityLog
    {
        public int Id { get; set; }
        public string PersonName { get; set; }
        public string ProductName { get; set; }
        public decimal ProductPrice { get; set; }
        public string Status { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class CreateRequestDto
    {
        public string PersonName { get; set; }
        public decimal Budget { get; set; }
        public string ProductType { get; set; }
    }
}

<style>
.dashboard { padding: 20px; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
.stat-card { background: #f0f0f0; padding: 20px; border-radius: 8px; }
.number { font-size: 2em; font-weight: bold; color: #0066cc; }
.section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
.btn-primary { background: #0066cc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
.btn-logout { background: #cc0000; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
th { background: #f0f0f0; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }
.badge.success { background: #d4edda; color: #155724; }
.badge.error { background: #f8d7da; color: #721c24; }
</style>
