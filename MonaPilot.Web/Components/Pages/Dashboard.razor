@page "/"
@using System.Net.Http.Json
@using System.Net.Http.Headers
@inject HttpClient Http
@inject NavigationManager Nav
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage

<PageTitle>MonaPilot - Dashboard</PageTitle>

@if (!isAuthenticated)
{
    <p>Redirecting to login...</p>
}
else
{
<div class="dashboard">
    <div class="header">
        <h1>MonaPilot Dashboard</h1>
        <div>
            <span class="welcome">Welcome, @currentUser</span>
            <button @onclick="Logout" class="btn-logout">Logout</button>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="alert @statusClass">@statusMessage</div>
    }

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else
    {
        <div class="stats">
            <div class="stat-card">
                <h3>Total Requests</h3>
                <p class="number">@totalRequests</p>
            </div>
            <div class="stat-card">
                <h3>Completed</h3>
                <p class="number">@completedRequests</p>
            </div>
            <div class="stat-card">
                <h3>Total Spent</h3>
                <p class="number">$@totalSpent</p>
            </div>
        </div>

        <div class="section">
            <h2>New Request</h2>
            <div class="form">
                <input type="text" @bind="newRequest.PersonName" placeholder="Name" />
                <input type="number" @bind="newRequest.Budget" placeholder="Budget" />
                <select @bind="newRequest.ProductType">
                    <option value="">-- Select Type --</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Furniture">Furniture</option>
                    <option value="Books">Books</option>
                </select>
                <button @onclick="CreateRequest" class="btn-primary" disabled="@isSubmitting">
                    @(isSubmitting ? "Submitting..." : "Submit")
                </button>
            </div>
        </div>

        <div class="section">
            <h2>Recent Activity</h2>
            @if (logs.Count > 0)
            {
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in logs.Take(10))
                        {
                            <tr>
                                <td>@log.PersonName</td>
                                <td>@log.ProductName</td>
                                <td>$@log.ProductPrice</td>
                                <td><span class="badge @log.Status?.ToLower()">@log.Status</span></td>
                                <td>@log.CreatedAt.ToString("MM/dd HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No activity yet</p>
            }
        </div>

        <div class="section">
            <h2>All Budget Requests</h2>
            @if (budgetRequests.Count > 0)
            {
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Budget</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var req in budgetRequests.OrderByDescending(r => r.Id).Take(10))
                        {
                            <tr>
                                <td>#@req.Id</td>
                                <td>@req.PersonName</td>
                                <td>$@req.Budget</td>
                                <td>@req.ProductType</td>
                                <td><span class="badge @req.Status?.ToLower()">@req.Status</span></td>
                                <td>@req.CreatedAt.ToString("MM/dd HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
            else
            {
                <p>No requests yet. Create your first one above!</p>
            }
        </div>
    }
</div>
}

@code {
    private bool isAuthenticated = false;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string currentUser = "";
    private string statusMessage = "";
    private string statusClass = "";
    private int totalRequests = 0;
    private int completedRequests = 0;
    private decimal totalSpent = 0;
    private List<ActivityLog> logs = new();
    private List<BudgetRequest> budgetRequests = new();
    private CreateRequestDto newRequest = new() { ProductType = "Electronics" };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var token = await SessionStorage.GetItemAsync<string>("authToken");
            if (string.IsNullOrEmpty(token))
            {
                Nav.NavigateTo("/login");
                return;
            }

            currentUser = await SessionStorage.GetItemAsync<string>("username") ?? "User";
            isAuthenticated = true;
            Http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
            StateHasChanged();

            await LoadData();
            StateHasChanged();
        }
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;

            // Load activity logs
            var logsResponse = await Http.GetAsync("api/productrequest/logs/all");
            if (logsResponse.IsSuccessStatusCode)
            {
                logs = await logsResponse.Content.ReadFromJsonAsync<List<ActivityLog>>() ?? new();
                totalRequests = logs.Count;
                completedRequests = logs.Count(l => l.Status == "Success");
                totalSpent = logs.Sum(l => l.ProductPrice);
            }

            // Load budget requests
            var reqResponse = await Http.GetAsync("api/productrequest/all");
            if (reqResponse.IsSuccessStatusCode)
            {
                budgetRequests = await reqResponse.Content.ReadFromJsonAsync<List<BudgetRequest>>() ?? new();
                if (totalRequests == 0) totalRequests = budgetRequests.Count;
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error loading data: {ex.Message}";
            statusClass = "alert-error";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task CreateRequest()
    {
        if (string.IsNullOrWhiteSpace(newRequest.PersonName))
        {
            statusMessage = "Please enter a name.";
            statusClass = "alert-error";
            return;
        }
        if (newRequest.Budget <= 0)
        {
            statusMessage = "Budget must be greater than 0.";
            statusClass = "alert-error";
            return;
        }
        if (string.IsNullOrEmpty(newRequest.ProductType))
        {
            statusMessage = "Please select a product type.";
            statusClass = "alert-error";
            return;
        }

        try
        {
            isSubmitting = true;
            statusMessage = "";

            var response = await Http.PostAsJsonAsync("api/productrequest/request", newRequest);
            if (response.IsSuccessStatusCode)
            {
                statusMessage = $"Request created for {newRequest.PersonName} (${newRequest.Budget} - {newRequest.ProductType})";
                statusClass = "alert-success";
                newRequest = new() { ProductType = "Electronics" };
                await LoadData();
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.Unauthorized)
            {
                statusMessage = "Session expired. Please login again.";
                statusClass = "alert-error";
                await Task.Delay(1500);
                Nav.NavigateTo("/login");
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                statusMessage = $"Failed: {error}";
                statusClass = "alert-error";
            }
        }
        catch (Exception ex)
        {
            statusMessage = $"Error: {ex.Message}";
            statusClass = "alert-error";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task Logout()
    {
        await SessionStorage.RemoveItemAsync("authToken");
        await SessionStorage.RemoveItemAsync("username");
        Http.DefaultRequestHeaders.Authorization = null;
        Nav.NavigateTo("/login");
    }

    public class ActivityLog
    {
        public int Id { get; set; }
        public string? PersonName { get; set; }
        public string? ProductName { get; set; }
        public decimal ProductPrice { get; set; }
        public string? Status { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class BudgetRequest
    {
        public int Id { get; set; }
        public string? PersonName { get; set; }
        public decimal Budget { get; set; }
        public string? ProductType { get; set; }
        public string? Status { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class CreateRequestDto
    {
        public string? PersonName { get; set; }
        public decimal Budget { get; set; }
        public string? ProductType { get; set; }
    }
}

<style>
.dashboard { padding: 20px; max-width: 1200px; margin: 0 auto; }
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
.header h1 { margin: 0; color: #333; }
.welcome { margin-right: 15px; color: #666; font-size: 14px; }
.stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
.stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white; }
.stat-card h3 { margin: 0 0 10px 0; font-size: 14px; opacity: 0.9; }
.number { font-size: 2em; font-weight: bold; margin: 0; }
.section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.section h2 { margin-top: 0; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px; }
.form { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; align-items: end; }
input, select { padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
input:focus, select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
.btn-primary { background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; }
.btn-primary:hover:not(:disabled) { background: #5568d3; }
.btn-primary:disabled { background: #ccc; cursor: not-allowed; }
.btn-logout { background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 13px; }
.btn-logout:hover { background: #c82333; }
table { width: 100%; border-collapse: collapse; }
th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
th { background: #f8f9fa; font-weight: 600; color: #555; }
.badge { padding: 4px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 600; }
.badge.success { background: #d4edda; color: #155724; }
.badge.pending { background: #fff3cd; color: #856404; }
.badge.failed, .badge.error { background: #f8d7da; color: #721c24; }
.alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }
.alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
.alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
</style>
